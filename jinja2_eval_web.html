<html>
<head>
  <title>Jinja2 Web Evaluator</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- CodeMirror CSS & Themes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Popper and Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <!-- CodeMirror JS and modes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/jinja2/jinja2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/yaml/yaml.min.js"></script>
  <style>
    /* Dark mode styles */
    body.dark-mode { background-color: #1e1e1e; color: #ccc; }
    .card.dark-mode { background-color: #2e2e2e; color: #ddd; }
    body.dark-mode .bg-light { background-color: #444 !important; color: #eee !important; }
    body.dark-mode .form-control, body.dark-mode .form-select { background-color: #333; color: #eee; border-color: #555; }
    body.dark-mode .btn { background-color: #555; color: #eee; border-color: #666; }
    body.dark-mode .modal-content { background-color: #2e2e2e; color: #ddd; }
    body.dark-mode .modal-header, body.dark-mode .modal-footer { border-color: #555; }
    body.dark-mode .btn-close { filter: invert(1); }
    /* CodeMirror styling with vertical resize */
    .CodeMirror {
      border: 1px solid #ccc;
      font-family: monospace;
      font-size: 14px;
      resize: vertical !important;
      overflow: auto;
    }
    body.dark-mode .CodeMirror { border: 1px solid #555; }
    .note { font-style: italic; color: #555; }
    body.dark-mode .note { color: #aaa; }
    #top-controls { position: absolute; top: 20px; right: 20px; z-index: 1050; }
  </style>
</head>
<body>
  <div id="top-controls">
    <button id="settings-toggle" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">Settings</button>
  </div>

  <div class="container-fluid my-4">
    <h1 class="text-center mb-4">Jinja2 Web Evaluate <small class="text-muted" id="version">v1.1</small></h1>
    <div class="mb-3 mx-auto" style="width:90%;">
      <label for="history-select" class="form-label">Load from History</label>
      <select id="history-select" class="form-select">
        <option value="">-- Select past entry --</option>
      </select>
    </div>

    <!-- JSON Input -->
    <div class="card mb-4 mx-auto" style="width:90%;">
      <div class="card-body position-relative">
        <button class="btn btn-sm btn-outline-secondary position-absolute" style="top:10px; right:10px; z-index:10;" onclick="downloadContent(inputEditor, 'input.json')">Download</button>
        <h2 class="card-title bg-light p-2">JSON Input</h2>
        <form id="upload-form" class="mb-3">
          <div class="input-group">
            <input type="file" class="form-control" id="jsonfile" name="jsonfile">
            <button type="submit" class="btn btn-primary">Load JSON</button>
          </div>
        </form>
        <div class="mb-2">
          <select id="input-mode" class="form-select w-auto">
            <option value="application/json">JSON</option>
            <option value="text/x-yaml">YAML</option>
          </select>
        </div>
        <textarea id="inputcode"></textarea>
      </div>
    </div>

    <!-- Jinja Expression -->
    <div class="card mb-4 mx-auto" style="width:90%;">
      <div class="card-body position-relative">
        <button class="btn btn-sm btn-outline-secondary position-absolute" style="top:10px; right:10px; z-index:10;" onclick="downloadContent(jinjaEditor, 'jinja2_expression.j2')">Download</button>
        <h2 class="card-title bg-light p-2">Jinja Expression</h2>
        <div class="note mb-2">Use <code>data</code> variable for JSON input.</div>
        <textarea id="jinjaexpr"></textarea>
      </div>
    </div>

    <!-- Result -->
    <div class="card mb-4 mx-auto" style="width:90%;">
      <div class="card-body position-relative">
        <button class="btn btn-sm btn-outline-secondary position-absolute" style="top:10px; right:10px; z-index:10;" onclick="downloadContent(resultEditor, 'result.json')">Download</button>
        <h2 class="card-title bg-light p-2">Result <small id="result-type" class="text-muted"></small></h2>
        <div class="mb-2">
          <select id="result-mode" class="form-select w-auto">
            <option value="application/json">JSON</option>
            <option value="text/plain">Plain text</option>
            <option value="text/x-yaml">YAML</option>
            <option value="application/xml">XML</option>
          </select>
        </div>
        <textarea id="resultview" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="theme-select" class="form-label">Editor Theme</label>
            <select id="theme-select" class="form-select">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="height-inputcode" class="form-label">JSON Editor Height (px)</label>
            <input type="number" class="form-control" id="height-inputcode">
          </div>
          <div class="mb-3">
            <label for="height-jinjaexpr" class="form-label">Jinja Expression Editor Height (px)</label>
            <input type="number" class="form-control" id="height-jinjaexpr">
          </div>
          <div class="mb-3">
            <label for="height-resultview" class="form-label">Result Editor Height (px)</label>
            <input type="number" class="form-control" id="height-resultview">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="reset-heights" class="btn btn-warning">Reset Heights</button>
          <button type="button" id="save-settings" class="btn btn-primary">Save Settings</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let historyMap = [], inputEditor, jinjaEditor, resultEditor;
    const themes = {
      light: 'eclipse', dark: 'dracula'
    };
    let currentTheme;

    function applyTheme(theme) {
      $('body').toggleClass('dark-mode', theme==='dark');
      $('.card, .modal-content').toggleClass('dark-mode', theme==='dark');
      inputEditor.setOption('theme', themes[theme]);
      jinjaEditor.setOption('theme', themes[theme]);
      resultEditor.setOption('theme', themes[theme]);
    }

    function loadHistoryList() {
      $.getJSON('/history', data => {
        const sel = $('#history-select').empty().append('<option value="">-- Select past entry --</option>');
        historyMap = data;
        data.forEach((e,i) => sel.append(`<option value="${i}">${e.datetime} | ${e.expr.slice(0,50).replace(/\n/g,' ')} | ${e.input.slice(0,50).replace(/\n/g,' ')}</option>`));
      });
    }

    // Utility to download editor content
    function downloadContent(editor, filename) {
      const content = editor.getValue();
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    $(document).ready(() => {
      inputEditor = CodeMirror.fromTextArea($('#inputcode')[0], { mode:'application/json',
        lineNumbers:true, lineWrapping:true, tabSize:2 });
      jinjaEditor = CodeMirror.fromTextArea($('#jinjaexpr')[0], { mode:'jinja2',
        lineNumbers:true, lineWrapping:true, tabSize:2 });
      resultEditor = CodeMirror.fromTextArea($('#resultview')[0], { mode:'application/json',
        lineNumbers:true, readOnly:true, lineWrapping:true, tabSize:2 });

      $('#settingsModal').on('show.bs.modal', () => {
        $.getJSON('/settings?section=user', s => {
          $('#theme-select').val(s.theme||'dark');
          $('#height-inputcode').val(s['height-inputcode']||100);
          $('#height-jinjaexpr').val(s['height-jinjaexpr']||100);
          $('#height-resultview').val(s['height-resultview']||1000);
        });
      });

      $('#save-settings').click(() => {
        const payload = {
          section:'user',
          theme:$('#theme-select').val(),
          'height-inputcode':$('#height-inputcode').val(),
          'height-jinjaexpr':$('#height-jinjaexpr').val(),
          'height-resultview':$('#height-resultview').val()
        };
        $.post('/settings', payload).done(() => {
          currentTheme = payload.theme;
          applyTheme(currentTheme);
          inputEditor.setSize('100%', +payload['height-inputcode']);
          jinjaEditor.setSize('100%', +payload['height-jinjaexpr']);
          resultEditor.setSize('100%', +payload['height-resultview']);
          $('#settingsModal').modal('hide');
          loadHistoryList();
        });
      });

      $('#reset-heights').click(() => {
        const defs = { 'height-inputcode':100, 'height-jinjaexpr':100, 'height-resultview':1000 };
        const payload = Object.assign({ section:'user' }, defs);
        $.post('/settings', payload).done(() => {
          inputEditor.setSize('100%', defs['height-inputcode']);
          jinjaEditor.setSize('100%', defs['height-jinjaexpr']);
          resultEditor.setSize('100%', defs['height-resultview']);
          $('#height-inputcode').val(defs['height-inputcode']);
          $('#height-jinjaexpr').val(defs['height-jinjaexpr']);
          $('#height-resultview').val(defs['height-resultview']);
        });
      });

      $('#input-mode').change(()=>inputEditor.setOption('mode',$('#input-mode').val()));
      $('#upload-form').submit(e => {
        e.preventDefault();
        const f=$('#jsonfile')[0].files[0];
        if(f) {
          const r=new FileReader();
          r.onload=evt=>{inputEditor.setValue(evt.target.result);jinjaEditor.setValue('{{ data }}');sendRender();};
          r.readAsText(f);
        }
      });
      inputEditor.on('change',sendRender);
      jinjaEditor.on('change',sendRender);
      if(!jinjaEditor.getValue())jinjaEditor.setValue('{{ data }}');
      $('#result-mode').change(()=>resultEditor.setOption('mode',$('#result-mode').val()));
      $('#history-select').change(()=>{
        const idx=$('#history-select').val(); if(idx==='')return;
        const e=historyMap[idx]; inputEditor.setValue(e.input); jinjaEditor.setValue(e.expr); sendRender();
      });

      $.getJSON('/settings?section=user', s=>{
        currentTheme=s.theme||'dark'; applyTheme(currentTheme);
        inputEditor.setSize('100%',+s['height-inputcode']||100);
        jinjaEditor.setSize('100%',+s['height-jinjaexpr']||100);
        resultEditor.setSize('100%',+s['height-resultview']||1000);
        loadHistoryList(); sendRender();
      });

      function sendRender(){
        $.post('/render',{json:inputEditor.getValue(),expr:jinjaEditor.getValue()})
        .done((d,_,xhr)=>{const rt=xhr.getResponseHeader('X-Result-Type')||'string';$('#result-type').text('('+rt+')');try{const p=JSON.parse(d);resultEditor.setValue(JSON.stringify(p,null,2));}catch{resultEditor.setValue(d);}})
        .fail(xhr=>{resultEditor.setValue('Error:'+xhr.responseText);$('#result-type').text('(error)');});
      }
    });
  </script>
</body>
</html>
